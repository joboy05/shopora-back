// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider   = "prisma-client-js"
  output     = "../generated/prisma"
  engineType = "library"
}

datasource db {
  provider = "sqlite"
}

model Store {
  id                        String                 @id @default(uuid())
  name                      String
  email                     String
  phone                     String?
  billingAddress            String?
  defaultCurrency           String                 @default("EUR")
  defaultRegion             String                 @default("FR")
  unitSystem                String                 @default("metric")
  weightUnit                String                 @default("kg")
  passwordProtectionEnabled Boolean                @default(true)
  passwordHash              String?
  createdAt                 DateTime               @default(now())
  updatedAt                 DateTime               @updatedAt
  users                     User[]
  markets                   Market[]
  catalogs                  Catalog[]
  pages                     Page[]
  themes                    Theme[]
  taxRules                  TaxRule[]
  payouts                   Payout[]
  products                  Product[]
  orders                    Order[]
  customers                 Customer[]
  metaobjectDefinitions     MetaobjectDefinition[]
}

model MetaobjectDefinition {
  id               String            @id @default(uuid())
  storeId          String
  store            Store             @relation(fields: [storeId], references: [id])
  name             String
  type             String            @unique // e.g., 'designer', 'size_guide'
  description      String?
  fieldDefinitions Json // Array of { name, type, key, required }
  entries          MetaobjectEntry[]
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
}

model MetaobjectEntry {
  id           String               @id @default(uuid())
  definitionId String
  definition   MetaobjectDefinition @relation(fields: [definitionId], references: [id])
  fields       Json // Key-value pairs matching definition
  createdAt    DateTime             @default(now())
  updatedAt    DateTime             @updatedAt
}

model Metafield {
  id        String   @id @default(uuid())
  ownerId   String // ID of Product, Order, etc.
  ownerType String // 'Product', 'Order', etc.
  namespace String
  key       String
  value     String
  type      String // 'single_line_text_field', 'json', etc.
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([ownerId, ownerType, namespace, key])
}

model Customer {
  id        String   @id @default(uuid())
  storeId   String
  store     Store    @relation(fields: [storeId], references: [id])
  email     String   @unique
  firstName String?
  lastName  String?
  orders    Order[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Order {
  id         String      @id @default(uuid())
  storeId    String
  store      Store       @relation(fields: [storeId], references: [id])
  customerId String
  customer   Customer    @relation(fields: [customerId], references: [id])
  status     String      @default("pending") // pending, paid, fulfilled, cancelled
  total      Float
  items      OrderItem[]
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt
}

model OrderItem {
  id        String         @id @default(uuid())
  orderId   String
  order     Order          @relation(fields: [orderId], references: [id], onDelete: Cascade)
  variantId String
  variant   ProductVariant @relation(fields: [variantId], references: [id])
  quantity  Int
  price     Float
}

model Product {
  id          String           @id @default(uuid())
  storeId     String
  store       Store            @relation(fields: [storeId], references: [id])
  name        String
  description String?
  status      String           @default("draft") // draft, active, archived
  handle      String?          @unique
  tags        String? // Comma separated for SQLite demo
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  variants    ProductVariant[]
}

model ProductVariant {
  id                String      @id @default(uuid())
  productId         String
  product           Product     @relation(fields: [productId], references: [id], onDelete: Cascade)
  sku               String?     @unique
  price             Float
  compareAtPrice    Float?
  inventoryQuantity Int         @default(0)
  options           Json? // { size: 'XL', color: 'Red' }
  orderItems        OrderItem[]
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
}

model User {
  id               String   @id @default(uuid())
  storeId          String
  store            Store    @relation(fields: [storeId], references: [id])
  email            String   @unique
  password         String
  role             String   @default("ADMIN") // ADMIN, CUSTOMER
  status           String   @default("active")
  twoFactorEnabled Boolean  @default(false)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}

model Market {
  id           String    @id @default(uuid())
  storeId      String
  store        Store     @relation(fields: [storeId], references: [id])
  name         String
  status       String    @default("inactive") // active, inactive
  countries    String? // Comma separated for SQLite demo (ISO country codes)
  currency     String
  language     String?
  domain       String?
  pricingRules Json? // { conversionType: 'auto' | 'manual', margin: number, rounding: string }
  taxRules     TaxRule[]
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
}

model Catalog {
  id                   String   @id @default(uuid())
  storeId              String
  store                Store    @relation(fields: [storeId], references: [id])
  name                 String
  status               String   @default("inactive")
  productSelectionRule Json? // { type: 'all' | 'collection' | 'tag' | 'manual', values: string[] }
  pricingRule          Json? // { adjustmentType: 'percentage' | 'fixed', value: number }
  marketIds            String? // Comma separated for SQLite demo 
  priority             Int      @default(0)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
}

model Page {
  id         String   @id @default(uuid())
  storeId    String
  store      Store    @relation(fields: [storeId], references: [id])
  title      String
  slug       String
  content    String?
  visibility String   @default("hidden") // visible, hidden
  seoTitle   String?
  seoDesc    String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

model Theme {
  id        String   @id @default(uuid())
  storeId   String
  store     Store    @relation(fields: [storeId], references: [id])
  name      String
  version   String
  status    String   @default("inactive") // current, inactive
  settings  Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model TaxRule {
  id        String   @id @default(uuid())
  storeId   String
  store     Store    @relation(fields: [storeId], references: [id])
  marketId  String
  market    Market   @relation(fields: [marketId], references: [id])
  name      String
  rate      Float
  priority  Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Payout {
  id         String    @id @default(uuid())
  storeId    String
  store      Store     @relation(fields: [storeId], references: [id])
  amount     Float
  currency   String
  status     String    @default("pending") // pending, paid, failed, cancelled
  bankRef    String?
  payoutDate DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
}
